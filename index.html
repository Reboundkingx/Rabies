<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sarawak Vet Squad: Vaccine Vantage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Nunito:wght@700&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            overscroll-behavior: none;
            touch-action: none;
            background-color: #111827; 
        }

        h1, .arcade-text {
            font-family: 'Bangers', cursive;
            letter-spacing: 2px;
        }

        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 30;
        }

        .glow-text {
            text-shadow: 0 0 10px #facc15, 0 0 20px #ca8a04;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }

        /* Boss Health Bar */
        #bossContainer { transition: opacity 0.5s; }

        /* Chat Bubble Styles */
        .chat-bubble { max-width: 80%; margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; line-height: 1.4; }
        .user-bubble { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai-bubble { background-color: #374151; color: #e5e7eb; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #4b5563; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #374151; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6B7280; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
    </style>
</head>
<body class="h-screen w-full overflow-hidden text-white select-none">

    <div class="scanlines"></div>

    <!-- Main Menu -->
    <div id="mainMenu" class="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
        <div class="floating mb-4 text-8xl">üëÆ‚Äç‚ôÇÔ∏èüíâüê∫</div>
        <h1 class="text-5xl md:text-7xl text-yellow-400 mb-2 glow-text">SARAWAK<br>VET SQUAD</h1>
        <p class="text-blue-300 mb-8 text-xl font-bold tracking-wider">ENDLESS OPERATION</p>
        
        <div class="space-y-4 w-full max-w-xs relative z-50">
            <button onclick="startArcadeGame()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:scale-105 transition transform text-white text-2xl font-bold py-4 rounded-xl shadow-[0_4px_0_rgb(21,128,61)] active:shadow-none active:translate-y-1">
                START MISSION
            </button>
            <button onclick="startFullQuiz()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:scale-105 transition transform text-white text-xl font-bold py-4 rounded-xl shadow-[0_4px_0_rgb(30,58,138)] active:shadow-none active:translate-y-1">
                TRAINING QUIZ
            </button>
            <button onclick="openDrDoggyChat()" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:scale-105 transition transform text-white text-xl font-bold py-4 rounded-xl shadow-[0_4px_0_rgb(147,51,234)] active:shadow-none active:translate-y-1 flex items-center justify-center gap-2">
                <span>‚ú®</span> ASK DR. DOGGY
            </button>
        </div>
    </div>

    <!-- Game HUD -->
    <div id="gameHUD" class="absolute top-0 left-0 w-full p-4 flex justify-between z-20 hidden pointer-events-none">
        <div class="flex flex-col">
            <span class="arcade-text text-yellow-400 text-xl">SCORE</span>
            <span id="scoreDisplay" class="text-3xl font-black leading-none">0</span>
            <div id="levelDisplay" class="text-blue-400 font-bold text-lg mt-1">LEVEL 1: VILLAGE</div>
        </div>
        
        <!-- Boss Bar -->
        <div id="bossContainer" class="absolute top-16 left-1/2 transform -translate-x-1/2 w-1/2 max-w-xs opacity-0">
             <div class="text-red-500 font-black text-center text-sm mb-1 tracking-widest">‚ö†Ô∏è RABID ALPHA ‚ö†Ô∏è</div>
             <div class="w-full h-4 bg-gray-800 rounded-full border-2 border-red-900 overflow-hidden">
                 <div id="bossHealthBar" class="h-full bg-red-600 transition-all duration-200" style="width: 100%"></div>
             </div>
        </div>

        <div class="flex flex-col items-end">
             <span class="arcade-text text-red-400 text-xl">HEALTH</span>
             <div id="livesDisplay" class="text-3xl tracking-widest">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
    </div>

    <!-- Level Up Overlay -->
    <div id="levelOverlay" class="absolute inset-0 flex items-center justify-center z-40 pointer-events-none hidden">
        <h2 id="levelText" class="text-6xl font-black text-yellow-400 arcade-text drop-shadow-[0_5px_5px_rgba(0,0,0,1)] animate-bounce">LEVEL 2</h2>
    </div>

    <!-- Canvas Layer -->
    <canvas id="gameCanvas" class="block w-full h-full bg-gray-900 hidden"></canvas>

    <!-- Universal Modal (Quiz, Game Over) -->
    <div id="universalModal" class="absolute inset-0 z-50 bg-black/95 hidden flex flex-col items-center justify-center p-4">
        <div class="bg-gray-800 border-4 border-blue-500 text-white rounded-2xl p-6 max-w-md w-full shadow-2xl text-center relative flex flex-col" style="max-height: 80vh;">
            <div id="modalBadge" class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-blue-600 px-6 py-2 rounded-full font-bold shadow-lg border-2 border-white hidden">BADGE</div>
            <h2 id="modalTitle" class="mt-6 text-3xl font-bold mb-2 text-yellow-400 arcade-text flex-shrink-0">TITLE</h2>
            
            <!-- Quiz Content -->
            <div id="quizContainer" class="hidden w-full overflow-y-auto custom-scrollbar px-2 flex-1">
                <div class="mb-2 text-blue-300 text-sm font-bold tracking-widest">QUESTION <span id="qIndex">1</span>/<span id="qTotal">8</span></div>
                <div class="h-2 w-full bg-gray-700 rounded-full mb-6"><div id="progressBar" class="h-full bg-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                <p id="quizQuestion" class="text-lg mb-6 font-semibold">Question text...</p>
                <div id="quizOptions" class="grid grid-cols-1 gap-3 mb-4 w-full"></div>
                <div id="quizFeedback" class="hidden p-3 rounded bg-gray-700 font-bold text-sm mb-4"></div>
            </div>

            <!-- Results Content (Flex to fit) -->
            <div id="resultsContainer" class="hidden w-full flex-1 flex flex-col min-h-0 overflow-hidden">
                <p id="resultSubtitle" class="text-gray-300 text-xl mb-2 flex-shrink-0">FINAL SCORE</p>
                <p id="resultBigText" class="text-6xl font-black text-yellow-400 mb-4 arcade-text flex-shrink-0">0</p>
                <p id="resultMessage" class="text-sm text-gray-400 mb-4 font-bold text-blue-300 flex-shrink-0">Status Check...</p>
                
                <!-- AI Box with Scroll Fix -->
                <div class="bg-gray-700/50 p-4 rounded-xl border border-gray-600 mb-4 text-left flex-1 flex flex-col min-h-[100px] overflow-hidden">
                    <p class="text-xs text-purple-400 font-bold mb-1 uppercase flex items-center gap-1 flex-shrink-0"><span>‚ú®</span> HQ Mission Debrief</p>
                    <!-- Added fixed max-height and scroll -->
                    <div id="aiDebriefContent" class="text-sm text-gray-300 italic overflow-y-auto custom-scrollbar max-h-[150px]">Connecting to HQ...</div>
                </div>
            </div>
            
            <button id="actionBtn" class="hidden w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transition mt-2 flex-shrink-0">CONTINUE</button>
        </div>
    </div>

    <!-- Dr. Doggy Chat Modal -->
    <div id="chatModal" class="absolute inset-0 z-[60] bg-black/90 hidden flex flex-col items-center justify-center p-4">
        <div class="bg-gray-800 border-4 border-purple-500 w-full max-w-md h-[80vh] rounded-2xl flex flex-col overflow-hidden shadow-2xl">
            <div class="bg-purple-600 p-4 flex justify-between items-center shadow-md z-10">
                <div class="flex items-center gap-3"><div class="bg-white p-2 rounded-full text-2xl">üê∂</div><div><h3 class="font-bold text-white text-lg leading-none">Dr. Doggy</h3><span class="text-purple-200 text-xs">Sarawak Rabies Expert</span></div></div>
                <div class="flex gap-2"><button onclick="manualSetKey()" class="text-xs bg-purple-800 hover:bg-purple-900 px-2 py-1 rounded text-purple-200 border border-purple-400">üîë KEY</button><button onclick="closeChat()" class="text-white hover:bg-purple-700 px-2 rounded-lg transition font-bold text-xl">‚úï</button></div>
            </div>
            <div id="chatHistory" class="flex-1 p-4 overflow-y-auto flex flex-col bg-gray-900/50"><div class="ai-bubble chat-bubble">Woof! I'm Dr. Doggy. üêï<br>Ask me anything about Rabies prevention!</div></div>
            <div class="p-4 bg-gray-800 border-t border-gray-700"><div class="flex gap-2"><input type="text" id="chatInput" class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ask about Rabies..." onkeypress="if(event.key==='Enter') sendChatMessage()"><button onclick="sendChatMessage()" class="bg-purple-600 hover:bg-purple-700 text-white rounded-lg px-4 py-2 transition font-bold">SEND</button></div></div>
        </div>
    </div>

    <script>
        // --- GEMINI API INTEGRATION ---
        const apiKey = "AIzaSyDzvbHNZUKrUJ9R98qHkhZPAjST25IfzOM"; 
        
        async function callGemini(prompt, systemInstruction = "") {
            let keyToUse = apiKey;
            if (!keyToUse) keyToUse = localStorage.getItem("gemini_api_key");
            if (!keyToUse) {
                const userKey = prompt("üê∂ Dr. Doggy needs a voice! Paste Key:");
                if (userKey) { keyToUse = userKey.trim(); localStorage.setItem("gemini_api_key", keyToUse); } 
                else return "Error: API Key is missing.";
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) return "Error: Invalid API Key.";
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            } catch (error) { return "Connection error."; }
        }
        function manualSetKey() { const k = prompt("Enter Key:", localStorage.getItem("gemini_api_key")||""); if(k) localStorage.setItem("gemini_api_key", k.trim()); }

        // --- ASSETS & CONFIG ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const SPRITES = {
            player: 'üëÆ‚Äç‚ôÇÔ∏è', vaccine: 'üíâ', enemy_dog: 'üêï', enemy_bat: 'ü¶á', 
            boss: 'üê∫', boss_projectile: 'ü¶†', cured: 'ü•∞',
            power_spread: 'üí•', power_laser: '‚ö°', power_wave: 'üåä', shield: 'üõ°Ô∏è'
        };

        const ALL_QUESTIONS = [
            { q: "What is the '15 Minute Rule' for dog bites?", options: ["Sleep for 15 mins", "Wash wound with soap/water", "Run for 15 mins", "Wrap wound for 15 mins"], correct: 1, info: "Washing the wound with soap and running water for 15 minutes is crucial!" },
            { q: "Which area in Sarawak declared the first outbreak in 2017?", options: ["Kuching", "Serian", "Miri", "Sibu"], correct: 1, info: "It started in Serian before spreading." },
            { q: "What is the main carrier of Rabies in Sarawak?", options: ["Monkeys", "Bats", "Dogs", "Cats"], correct: 2, info: "99% of human cases are caused by dog bites." },
            { q: "Is Rabies curable after symptoms appear?", options: ["Yes, with pills", "No, it is almost 100% fatal", "Yes, with surgery", "Maybe"], correct: 1, info: "Once symptoms appear, it is fatal. Prevention is key!" },
            { q: "How often should dogs be vaccinated for Rabies?", options: ["Once only", "Every year (Annually)", "Every 10 years", "Never"], correct: 1, info: "Annual vaccination is required to maintain immunity." },
            { q: "What is a common sign of a rabid dog?", options: ["Purring", "Aggression & Drooling", "Sleepiness", "Eating Grass"], correct: 1, info: "Aggression, fear of water, and excessive saliva are red flags." },
            { q: "Which government body handles animal vaccination in Sarawak?", options: ["JPJ", "DVS (Vet Services)", "Fire Department", "Police"], correct: 1, info: "Department of Veterinary Services (DVS) leads the campaign." },
            { q: "Can cats get Rabies too?", options: ["No", "Yes, all mammals can", "Only if they eat dogs", "Only in West Malaysia"], correct: 1, info: "Yes! Cats, dogs, and humans are all susceptible mammals." }
        ];

        let appMode = 'menu'; 
        let arcadeState = { score: 0, lives: 3, frame: 0, lastTime: 0, level: 1, bossActive: false, difficulty: 1, spawnRate: 60 };
        let player = { x: 0, y: 0, size: 40, weapon: 'normal', shield: false };
        let bullets = [], enemies = [], particles = [], powerups = [], texts = [];
        let boss = { x: 0, y: 0, hp: 100, maxHp: 100, dir: 1, attackTimer: 0 };
        let input = { x: 0, y: 0, active: false };
        let quizState = { questions: [], currentIdx: 0, score: 0 };

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // --- ARCADE GAME LOGIC ---

        function startArcadeGame() {
            appMode = 'arcade';
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('gameHUD').classList.remove('hidden');
            canvas.classList.remove('hidden');
            
            arcadeState = { score: 0, lives: 3, frame: 0, lastTime: performance.now(), level: 1, bossActive: false, difficulty: 1, spawnRate: 60 };
            player = { x: canvas.width/2, y: canvas.height-100, size: 35, weapon: 'normal', shield: false };
            boss = { x: canvas.width/2, y: -100, hp: 100, maxHp: 100, dir: 1, attackTimer: 0 };
            bullets = []; enemies = []; particles = []; powerups = []; texts = [];
            
            updateLevelUI();
            requestAnimationFrame(gameLoop);
        }

        function gameLoop(timestamp) {
            if (appMode !== 'arcade') return;
            const dt = (timestamp - arcadeState.lastTime) / 16.67;
            arcadeState.lastTime = timestamp;
            arcadeState.frame++;
            updateArcade(dt);
            drawArcade();
            requestAnimationFrame(gameLoop);
        }

        function updateArcade(dt) {
            // --- AGGRESSIVE Difficulty Ramping ---
            // Speed up every 5 seconds (300 frames)
            if (arcadeState.frame % 300 === 0) {
                arcadeState.difficulty += 0.15; // Faster speed
                arcadeState.spawnRate = Math.max(8, arcadeState.spawnRate - 5); // Faster spawning
                spawnFloatingText(canvas.width/2, canvas.height/2, "‚ö†Ô∏è SWARM INTENSIFYING!", "#EF4444");
            }

            // Level Progression (Trigger Boss but don't stop game)
            if (!arcadeState.bossActive) {
                if (arcadeState.score > 2000 && arcadeState.level < 3) setLevel(3);
                else if (arcadeState.score > 800 && arcadeState.level < 2) setLevel(2);
            }

            // Player Move
            if (input.active) {
                player.x += (input.x - player.x) * 0.15 * dt;
                player.y += (input.y - player.y) * 0.15 * dt;
            }
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));

            // Shooting
            let fireRate = player.weapon === 'laser' ? 5 : 15;
            if (arcadeState.frame % fireRate === 0) shoot();

            // Spawning
            // Boss Logic
            if (arcadeState.bossActive) {
                updateBoss(dt);
            }
            
            // *** CONTINUOUS SPAWNING (CHAOS MODE) ***
            // Enemies now spawn ALWAYS, even during boss fight.
            if (arcadeState.frame % Math.floor(arcadeState.spawnRate) === 0) spawnEnemy();

            // Bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.y -= (player.weapon === 'laser' ? 25 : 15) * dt;
                b.x += b.vx * dt || 0;
                if (b.type === 'wave') b.x += Math.sin(b.y * 0.05) * 10 * dt;
                if (b.y < -50 || b.x < 0 || b.x > canvas.width) bullets.splice(i, 1);
            }

            // Enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                e.y += e.speed * dt;
                if (e.type === 'bat') e.x += Math.sin(e.y * 0.05) * 5 * dt; 
                if (e.type === 'projectile') e.x += Math.sin(e.y * 0.02) * 2 * dt; 

                if (!e.cured && e.type !== 'projectile') {
                    for (let j = bullets.length - 1; j >= 0; j--) {
                        if (dist(bullets[j].x, bullets[j].y, e.x, e.y) < e.size + 15) {
                            if (player.weapon !== 'wave') bullets.splice(j, 1); 
                            cureEnemy(e);
                            break;
                        }
                    }
                }
                if (dist(player.x, player.y, e.x, e.y) < player.size + e.size - 10) {
                    if (!e.cured) {
                         playerHit();
                         if(e.type === 'projectile') enemies.splice(i, 1);
                    }
                }
                if (e.y > canvas.height + 50) enemies.splice(i, 1);
            }

            // Powerups
            for (let i = powerups.length - 1; i >= 0; i--) {
                let p = powerups[i];
                p.y += 4 * dt;
                if (dist(player.x, player.y, p.x, p.y) < player.size + 20) {
                    applyPowerup(p.type);
                    powerups.splice(i, 1);
                } else if (p.y > canvas.height) powerups.splice(i, 1);
            }

            particles.forEach((p, i) => { p.x += p.vx * dt; p.y += p.vy * dt; p.life -= 0.02 * dt; if(p.life <= 0) particles.splice(i, 1); });
            texts.forEach((t, i) => { t.y -= 1 * dt; t.life -= 0.015 * dt; if(t.life <= 0) texts.splice(i, 1); });
        }

        function setLevel(lvl) {
            arcadeState.level = lvl;
            const overlay = document.getElementById('levelOverlay');
            const txt = document.getElementById('levelText');
            overlay.classList.remove('hidden');
            
            if (lvl === 2) {
                txt.innerText = "LEVEL 2: CAVE AMBUSH";
                txt.className = "text-5xl font-black text-purple-400 arcade-text animate-bounce";
            } else if (lvl === 3) {
                txt.innerText = "BOSS FIGHT!";
                txt.className = "text-6xl font-black text-red-500 arcade-text animate-ping";
                startBossFight();
            }
            setTimeout(() => overlay.classList.add('hidden'), 2000);
            updateLevelUI();
        }

        function updateLevelUI() {
            const el = document.getElementById('levelDisplay');
            if (arcadeState.level === 1) el.innerText = "LEVEL 1: VILLAGE";
            if (arcadeState.level === 2) el.innerText = "LEVEL 2: BAT CAVE";
            if (arcadeState.level === 3) el.innerText = "LEVEL 3: ENDLESS WAR";
        }

        function startBossFight() {
            arcadeState.bossActive = true;
            boss.y = 100;
            boss.hp = 100;
            document.getElementById('bossContainer').style.opacity = 1;
        }

        function updateBoss(dt) {
            boss.x += 3 * boss.dir * dt; 
            if (boss.x > canvas.width - 50 || boss.x < 50) boss.dir *= -1;
            boss.attackTimer += dt;
            if (boss.attackTimer > 80) { 
                boss.attackTimer = 0;
                enemies.push({ x: boss.x, y: boss.y + 50, size: 20, speed: 7, type: 'projectile', cured: false });
            }
            for (let j = bullets.length - 1; j >= 0; j--) {
                if (dist(bullets[j].x, bullets[j].y, boss.x, boss.y) < 60) {
                    bullets.splice(j, 1);
                    boss.hp -= (player.weapon === 'laser' ? 0.5 : 1.5); 
                    spawnParticles(boss.x, boss.y + 20, '#ef4444', 2);
                    document.getElementById('bossHealthBar').style.width = `${Math.max(0, boss.hp)}%`;
                    if (boss.hp <= 0) bossDefeated();
                    break;
                }
            }
        }

        function bossDefeated() {
            // *** CONTINUOUS PLAY ***
            // Boss dying does NOT end game.
            arcadeState.bossActive = false;
            document.getElementById('bossContainer').style.opacity = 0;
            arcadeState.score += 5000;
            spawnFloatingText(boss.x, boss.y, "BOSS DEFEATED!", "#FACC15");
            spawnParticles(boss.x, boss.y, '#FACC15', 50);
            spawnFloatingText(canvas.width/2, canvas.height/3, "SURVIVE THE HORDE!", "#FFFFFF");
        }

        function shoot() {
            playSound('shoot');
            if (player.weapon === 'normal') {
                bullets.push({x: player.x, y: player.y-20, vx: 0});
            } else if (player.weapon === 'spread') {
                bullets.push({x: player.x, y: player.y-20, vx: 0});
                bullets.push({x: player.x, y: player.y-20, vx: -4});
                bullets.push({x: player.x, y: player.y-20, vx: 4});
                bullets.push({x: player.x, y: player.y-20, vx: -8});
                bullets.push({x: player.x, y: player.y-20, vx: 8});
            } else if (player.weapon === 'laser') {
                bullets.push({x: player.x, y: player.y-30, vx: 0}); 
            } else if (player.weapon === 'wave') {
                bullets.push({x: player.x, y: player.y-20, vx: 0, type: 'wave'});
            }
        }

        function spawnEnemy() {
            // *** INCREASED POWERUP DROP RATE (15%) ***
            if (Math.random() > 0.85) {
                const types = ['spread', 'laser', 'wave', 'shield'];
                const type = types[Math.floor(Math.random() * types.length)];
                powerups.push({x: Math.random()*(canvas.width-40)+20, y: -50, type: type});
                return;
            }
            let type = 'dog';
            if (arcadeState.level >= 2 && Math.random() > 0.5) type = 'bat';
            let speedMult = arcadeState.difficulty;
            enemies.push({
                x: Math.random()*(canvas.width-60)+30, 
                y: -50, 
                size: type === 'bat' ? 25 : 35, 
                speed: (type === 'bat' ? 5 : 3) * speedMult, 
                type: type,
                cured: false
            });
        }

        function cureEnemy(e) {
            if (e.type === 'projectile') return; 
            e.cured = true; e.speed *= 1.5; arcadeState.score += 100;
            spawnParticles(e.x, e.y, '#22c55e', 8);
            spawnFloatingText(e.x, e.y, "CURED!");
            document.getElementById('scoreDisplay').innerText = arcadeState.score;
            playSound('cure');
        }

        function applyPowerup(type) {
            playSound('powerup');
            if (type === 'shield') {
                player.shield = true;
                spawnFloatingText(player.x, player.y-40, "SHIELD UP!", "#3B82F6");
            } else {
                player.weapon = type;
                spawnFloatingText(player.x, player.y-40, type.toUpperCase() + "!", "#fbbf24");
                setTimeout(() => { player.weapon = 'normal'; }, 8000);
            }
        }

        function playerHit() {
            arcadeState.lives--;
            document.getElementById('livesDisplay').innerText = '‚ù§Ô∏è'.repeat(Math.max(0, arcadeState.lives));
            enemies = enemies.filter(e => dist(player.x, player.y, e.x, e.y) > 200);
            spawnParticles(player.x, player.y, '#ef4444', 20);
            playSound('hit');
            canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
            setTimeout(()=>canvas.style.transform='none', 50);
            if (arcadeState.lives <= 0) showGameOver(false);
        }

        function drawArcade() {
            ctx.fillStyle = '#111827'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = arcadeState.level === 2 ? 'rgba(168, 85, 247, 0.1)' : 'rgba(59, 130, 246, 0.1)';
            ctx.lineWidth = 2;
            const offset = (arcadeState.frame * 2) % 40;
            ctx.beginPath();
            for (let x=0; x<=canvas.width; x+=40) { ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); }
            for (let y=offset; y<=canvas.height; y+=40) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); }
            ctx.stroke();

            ctx.save(); ctx.translate(player.x, player.y);
            if (player.shield) {
                ctx.beginPath(); ctx.arc(0, 0, player.size+10, 0, Math.PI*2);
                ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 3; ctx.setLineDash([5,5]);
                ctx.rotate(arcadeState.frame * 0.05); ctx.stroke();
            }
            ctx.font = '40px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = "white";
            ctx.fillText(SPRITES.player, 0, 0);
            ctx.restore();

            if (arcadeState.bossActive) {
                ctx.save(); ctx.translate(boss.x, boss.y);
                ctx.font = '80px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(SPRITES.boss, 0, 0);
                ctx.restore();
            }

            ctx.font = '20px Arial'; ctx.textAlign = 'center'; ctx.fillStyle = "white";
            bullets.forEach(b => {
                if (player.weapon === 'laser') {
                    ctx.fillStyle = '#60a5fa'; ctx.fillRect(b.x-2, b.y, 4, 15);
                } else if (b.type === 'wave') {
                     ctx.fillStyle = '#34D399'; ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.fillText(SPRITES.vaccine, b.x, b.y);
                }
            });

            enemies.forEach(e => {
                ctx.save(); ctx.translate(e.x, e.y);
                if (e.cured) {
                    ctx.globalAlpha = 0.6; ctx.font = `${e.size}px Arial`; ctx.fillText(SPRITES.cured, 0, 0);
                } else {
                    if (e.type === 'projectile') {
                        ctx.font = '25px Arial'; ctx.fillText(SPRITES.boss_projectile, 0, 0);
                    } else {
                        ctx.font = `${e.size}px Arial`; 
                        ctx.fillText(e.type === 'bat' ? SPRITES.enemy_bat : SPRITES.enemy_dog, 0, 0);
                    }
                }
                ctx.restore();
            });

            powerups.forEach(p => {
                ctx.font = '30px Arial'; 
                let icon = SPRITES.power_spread;
                if (p.type === 'laser') icon = SPRITES.power_laser;
                if (p.type === 'wave') icon = SPRITES.power_wave;
                if (p.type === 'shield') icon = SPRITES.shield;
                ctx.fillText(icon, p.x, p.y);
            });

            particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); });
            texts.forEach(t => { ctx.globalAlpha = t.life; ctx.fillStyle = t.color; ctx.font = 'bold 20px Nunito'; ctx.fillText(t.text, t.x, t.y); });
            ctx.globalAlpha = 1;
        }

        // --- Utils & Input ---
        function dist(x1, y1, x2, y2) { return Math.hypot(x2-x1, y2-y1); }
        function spawnParticles(x, y, color, count) { for(let i=0;i<count;i++) particles.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:1,color}); }
        function spawnFloatingText(x, y, text, color) { texts.push({x,y,text,life:1,color}); }
        function handleMove(x, y) { input.x = x; input.y = y; input.active = true; }
        canvas.addEventListener('touchstart', e => handleMove(e.touches[0].clientX, e.touches[0].clientY-50), {passive:false});
        canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY-50); }, {passive:false});
        canvas.addEventListener('mousedown', e => handleMove(e.clientX, e.clientY));
        canvas.addEventListener('mousemove', e => { if(e.buttons===1) handleMove(e.clientX, e.clientY); });
        window.addEventListener('mouseup', () => input.active = false);
        window.addEventListener('touchend', () => input.active = false);

        // --- QUIZ & GAME OVER ---
        function startFullQuiz() { appMode = 'quiz'; document.getElementById('mainMenu').classList.add('hidden'); document.getElementById('gameHUD').classList.add('hidden'); canvas.classList.add('hidden'); quizState.questions = [...ALL_QUESTIONS].sort(() => Math.random() - 0.5); quizState.currentIdx = 0; quizState.score = 0; showQuizUI(); renderQuestion(); }
        function showQuizUI() { const m = document.getElementById('universalModal'); m.classList.remove('hidden'); document.getElementById('modalBadge').classList.remove('hidden'); document.getElementById('modalBadge').innerText = "üìö TRAINING"; document.getElementById('modalTitle').innerText = "KNOWLEDGE CHECK"; document.getElementById('quizContainer').classList.remove('hidden'); document.getElementById('resultsContainer').classList.add('hidden'); document.getElementById('actionBtn').classList.add('hidden'); }
        function renderQuestion() { const q = quizState.questions[quizState.currentIdx]; document.getElementById('qIndex').innerText = quizState.currentIdx + 1; document.getElementById('qTotal').innerText = quizState.questions.length; document.getElementById('progressBar').style.width = `${((quizState.currentIdx)/quizState.questions.length)*100}%`; document.getElementById('quizQuestion').innerText = q.q; const d = document.getElementById('quizOptions'); d.innerHTML = ''; document.getElementById('quizFeedback').classList.add('hidden'); document.getElementById('actionBtn').classList.add('hidden'); q.options.forEach((opt, i) => { const b = document.createElement('button'); b.className = "w-full text-left p-4 rounded-lg bg-gray-700 hover:bg-blue-600 font-bold transition border-2 border-gray-600"; b.innerText = opt; b.onclick = () => checkAnswer(i, q, b); d.appendChild(b); }); }
        function checkAnswer(i, q, btn) { const f = document.getElementById('quizFeedback'); const ab = document.getElementById('actionBtn'); const btns = document.getElementById('quizOptions').children; for(let b of btns) b.disabled = true; f.classList.remove('hidden'); f.innerText = q.info; ab.classList.remove('hidden'); if(i===q.correct) { btn.classList.add('bg-green-600'); f.classList.add('text-green-400'); quizState.score++; } else { btn.classList.add('bg-red-600'); btns[q.correct].classList.add('bg-green-600'); f.classList.add('text-red-400'); } if(quizState.currentIdx < quizState.questions.length-1) { ab.innerText="NEXT"; ab.onclick=()=>{quizState.currentIdx++; renderQuestion();} } else { ab.innerText="FINISH"; ab.onclick=showQuizResults; } }
        
        async function showQuizResults() {
            document.getElementById('quizContainer').classList.add('hidden'); document.getElementById('resultsContainer').classList.remove('hidden');
            document.getElementById('modalTitle').innerText = "COMPLETE"; document.getElementById('resultBigText').innerText = `${quizState.score}/${quizState.questions.length}`;
            const b = document.getElementById('actionBtn'); b.innerText = "MENU"; b.classList.remove('hidden'); b.onclick=goHome;
            const d = document.getElementById('aiDebriefContent'); d.innerHTML = '<span class="animate-pulse">üì° Analyzing...</span>';
            // UPDATED PROMPT: SHORT
            const r = await callGemini(`Quiz Score: ${quizState.score}/${quizState.questions.length}. Max 15 words feedback.`, "You are Squad Instructor.");
            d.innerHTML = marked.parse(r);
        }

        async function showGameOver(victory) {
            appMode = 'gameover';
            const m = document.getElementById('universalModal'); m.classList.remove('hidden');
            document.getElementById('modalBadge').classList.remove('hidden');
            document.getElementById('modalBadge').innerText = "GAME OVER";
            document.getElementById('modalTitle').innerText = "MISSION END";
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');
            document.getElementById('resultBigText').innerText = arcadeState.score;
            const msgEl = document.getElementById('resultMessage'); if (msgEl) msgEl.innerText = "";
            const b = document.getElementById('actionBtn'); b.innerText = "MENU"; b.classList.remove('hidden'); b.onclick=goHome;
            
            // UPDATED PROMPT: SHORT
            const d = document.getElementById('aiDebriefContent'); d.innerHTML = '<span class="animate-pulse">üì° Connecting...</span>';
            const r = await callGemini(`Game Score: ${arcadeState.score}. Max 15 words military debrief.`, "You are Squad Commander.");
            d.innerHTML = marked.parse(r);
        }

        function goHome() { document.getElementById('universalModal').classList.add('hidden'); document.getElementById('gameHUD').classList.add('hidden'); canvas.classList.add('hidden'); document.getElementById('mainMenu').classList.remove('hidden'); appMode = 'menu'; }
        function openDrDoggyChat() { document.getElementById('chatModal').classList.remove('hidden'); }
        function closeChat() { document.getElementById('chatModal').classList.add('hidden'); }
        async function sendChatMessage() { const i = document.getElementById('chatInput'); const h = document.getElementById('chatHistory'); const t = i.value.trim(); if(!t) return; const u = document.createElement('div'); u.className='user-bubble chat-bubble'; u.innerText=t; h.appendChild(u); i.value=''; h.scrollTop=h.scrollHeight; const l = document.createElement('div'); l.className='ai-bubble chat-bubble'; l.innerText='...'; h.appendChild(l); const r = await callGemini(t, "You are Dr. Doggy, friendly Sarawak vet."); h.removeChild(l); const a = document.createElement('div'); a.className='ai-bubble chat-bubble'; a.innerHTML=marked.parse(r); h.appendChild(a); h.scrollTop=h.scrollHeight; }

        // --- Audio ---
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        function playSound(t) { if(ac.state==='suspended') ac.resume(); const o=ac.createOscillator(), g=ac.createGain(); o.connect(g); g.connect(ac.destination); if(t==='shoot') { o.frequency.value=800; o.frequency.exponentialRampToValueAtTime(100, ac.currentTime+0.1); g.gain.value=0.05; g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime+0.1); o.start(); o.stop(ac.currentTime+0.1); } if(t==='cure') { o.frequency.value=400; o.frequency.linearRampToValueAtTime(1200, ac.currentTime+0.2); g.gain.value=0.1; o.start(); o.stop(ac.currentTime+0.2); } if(t==='hit') { o.type='sawtooth'; o.frequency.value=100; g.gain.value=0.2; o.start(); o.stop(ac.currentTime+0.3); } if(t==='powerup') { o.type='square'; o.frequency.value=300; o.frequency.linearRampToValueAtTime(600, ac.currentTime+0.2); g.gain.value=0.1; o.start(); o.stop(ac.currentTime+0.2); } }
    </script>
</body>
</html>